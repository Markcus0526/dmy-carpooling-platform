<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.pinche.order.appoint.dao.AppointMapper">
	<resultMap id="AppointResult" type="Appoint">
		<id property="id" column="id"/>
		<result property="order_type" column="order_type"/>
		<result property="passenger" column="passenger"/>
		<result property="driver" column="driver"/>
		<result property="from_" column="from_"/>
		<result property="to_" column="to_"/>
		<result property="average_price_platform" column="average_price_platform"/>
		<result property="price" column="price"/>
		<result property="pre_time" column="pre_time"/>
		<result property="remark" column="remark"/>
		<result property="cr_date" column="cr_date"/>
		<result property="ti_accept_order" column="ti_accept_order"/>
	    <result property="begin_exec_time" column="begin_exec_time"/>		
		<result property="driverarrival_time" column="driverarrival_time"/>
		<result property="beginservice_time" column="beginservice_time"/>
		<result property="stopservice_time" column="stopservice_time"/>
		<result property="pay_time" column="pay_time"/>
		<result property="pass_cancel_time" column="pass_cancel_time"/>
		<result property="driver_cancel_time" column="driver_cancel_time"/>		
		<result property="city_from" column="city_from"/>
		<result property="city_to" 	   column="city_to"/>
		<result property="has_evaluation_passenger"		column="has_evaluation_passenger"/>
		<result property="has_evaluation_driver" column="has_evaluation_driver" />
		<result property="password" column="password"/>
		<result property="begin_lat" column="begin_lat"/>
		<result property="begin_lng" column="begin_lng"/>
		<result property="end_lat" column="end_lat"/>
		<result property="end_lng" column="end_lng"/>
		<result property="freeze_points" column="freeze_points"/>
		<result property="total_distance" column="total_distance"/>
		<result property="order_city" column="order_city"/>
		<result property="status" column="status"/>
		<result property="deleted" column="deleted"/>		
		<result property="order_num" column="order_num"/>
	</resultMap>
	
	<resultMap id="TempInfoResult" type="TempInfo">
		<id property="id" column="id"/>
		<result property="order_num" column="order_num"/>
		<result property="seats_num" column="seats_num"/>
		<result property="is_cancelservice" column="is_cancelservice"/>
		<result property="cancelservice_time" column="cancelservice_time"/>
		<result property="is_broadcast_stop" column="is_broadcast_stop"/>
		<result property="turn_num" column="turn_num"/>
		<result property="ps_date" column="ps_date"/>
		<result property="start_lat" column="start_lat"/>
		<result property="start_lng" column="start_lng"/>
		<result property="start_addr" column="start_addr"/>
		<result property="end_lat" column="end_lat"/>
		<result property="end_lng" column="end_lng"/>
		<result property="end_addr" column="end_addr"/>
		<result property="pre_time" column="pre_time"/>
		<result property="price" column="price"/>
		<result property="order_cs_id" column="order_cs_id"/>
		<result property="is_from_onoffdutyorder" column="is_from_onoffdutyorder"/>
		<result property="orderonoffduty_id" column="orderonoffduty_id"/>
		<result property="publisher" column="publisher"/>
		<result property="reqcarstyle" column="reqcarstyle"/>
		<result property="remark" column="remark"/>
		<result property="enabled" column="enabled"/>
		<result property="deleted" column="deleted"/>
	</resultMap>
	
	<resultMap id="LongDistanceInfoResult" type="LongDistanceInfo">
		<id property="id" column="id"/>
		<result property="orderdriverlongdistance_id" column="orderdriverlongdistance_id"/>
		<result property="userid" column="userid"/>
		<result property="order_exec_cs_id" column="order_exec_cs_id"/>
		<result property="seat_num" column="seat_num"/>
		<result property="ps_date" column="ps_date"/>
		<result property="order_num" column="order_num"/>
		<result property="pre_time" column="pre_time"/>
		<result property="price" column="price"/>
		<result property="start_city" column="start_city"/>
		<result property="end_city" column="end_city"/>
		<result property="publisher" column="publisher"/>
		<result property="ps_time" column="ps_time"/>
		<result property="occupied_num" column="occupied_num"/>
		<result property="remark" column="remark"/>
		<result property="enabled" column="enabled"/>
	</resultMap>
	
	<resultMap id="OnoffdutyInfoResult" type="OnoffdutyInfo">
		<id property="id" column="id"/>
		<result property="which_days" column="which_days"/>
		<result property="orderdetails_id" column="orderdetails_id"/>
		<result property="driver_id" column="driver_id"/>
		<result property="order_num" column="order_num"/>
		<result property="is_cancelservice" column="is_cancelservice"/>
		<result property="cancelservice_time" column="cancelservice_time"/>
		<result property="alldays_beaccepted" column="alldays_beaccepted"/>
		<result property="from_date" column="from_date"/>
		<result property="price" column="price"/>
		<result property="start_lat" column="start_lat"/>
		<result property="start_lng" column="start_lng"/>
		<result property="start_addr" column="start_addr"/>
		<result property="end_lat" column="end_lat"/>
		<result property="end_lng" column="end_lng"/>
		<result property="pre_time" column="pre_time"/>
		<result property="publisher" column="publisher"/>
		<result property="publish_date" column="publish_date"/>
		<result property="reqcarstyle" column="reqcarstyle"/>
		<result property="remark" column="remark"/>
		<result property="enabled" column="enabled"/>
	</resultMap>
	
	<resultMap id="MidPointsResult" type="MidPoints">
		<id property="id" column="id"/>
		<result property="order_type" column="order_type"/>
		<result property="orderid" column="orderid"/>
		<result property="index" column="point_index"/>
		<result property="lat" column="lat"/>
		<result property="lng" column="lng"/>
		<result property="addr" column="addr"/>
		<result property="deleted" column="deleted"/>
	</resultMap>
	
	<insert id="insertMidpoint" parameterType="MidPoints" useGeneratedKeys="true" keyProperty="id">
		INSERT INTO midpoints (order_type, orderid, midpoints.point_index, lat, lng, addr, deleted) 
		VALUE (#{order_type}, #{orderid}, #{index}, #{lat}, #{lng}, #{addr}, 0)
	</insert>
	<delete id="deletedMidPoints" parameterType="java.util.Map">
	   delete from  midpoints where order_type=#{order_type} and orderid=#{detailsId}
	</delete>
	<select id="findOneById" resultType="Appoint" parameterType="long">
		         SELECT order_exec.* FROM 	(
         SELECT tbl_order.id,tbl_order.order_type,tbl_order.passenger,tbl_order.driver,tbl_order.from_,tbl_order.to_,tbl_order.average_price_platform,
        tbl_order.price,tbl_order.pre_time,tbl_order.remark,tbl_order.cr_date,tbl_order.ti_accept_order,tbl_order.begin_exec_time,
        tbl_order.driverarrival_time,tbl_order.beginservice_time,tbl_order.stopservice_time,tbl_order.pay_time,tbl_order.pass_cancel_time,
        tbl_order.driver_cancel_time,tbl_order.password,tbl_order.city_from,tbl_order.city_to,tbl_order.has_evaluation_passenger,tbl_order.has_evaluation_driver,
        tbl_order.begin_lat,tbl_order.begin_lng,tbl_order.end_lat,tbl_order.end_lng,tbl_order.freeze_points,tbl_order.total_distance,tbl_order.status,
        city.name as order_city ,tbl_order.deleted
          FROM  order_exec_cs tbl_order LEFT JOIN city 
         ON city.code = tbl_order.order_city 
         )  order_exec WHERE order_exec.id=#{id} AND order_exec.deleted=0 
	</select>
		
	<select id="getBalanceByUserId" resultType="Double">
		SELECT t.balance FROM user u INNER JOIN ts t ON u.id = t.userid WHERE u.id = 4 ORDER BY t.id DESC LIMIT 1 
	</select>
	
	<select id="findById" resultType="com.pinche.order.appoint.dao.Customer" parameterType="long">
		SELECT * FROM user WHERE id=#{id} AND deleted=0
	</select>
	<select id="findByPhone" resultType="com.pinche.order.appoint.dao.Customer" parameterType="string">
	  SELECT * FROM user WHERE phone=#{phone} AND deleted=0
	</select>
	
	<select id="findOneByUsername" resultType="com.pinche.order.appoint.dao.Customer" parameterType="java.util.Map">
		SELECT * FROM user WHERE username=#{username} AND deleted=0 
		<!-- SELECT * FROM user WHERE username='abc' AND deleted=0-->
	</select>
	<resultMap id="int1" type="java.util.Map">
	  <result property="freeze" column="freeze" />	 
	    <result property="freeze" column="unfreeze" />	 
	</resultMap>
	<select id="findFreezeStatus" parameterType="long" resultMap="int1">
	select 
     (select sum(a.sum) from ts a where a.order_cs_id=#{id}  and a.ts_type='tx_code_009') freeze,
     (select sum(a.sum) from ts a where a.order_cs_id=#{id}  and a.ts_type='tx_code_0010') unfreeze
	</select>
	
	<select id="findAccountFreeze" parameterType="java.util.Map" resultType="int">
	 select count(*) from ts where ts.order_cs_id=#{id} and ts.userid=#{userid} and ts.ts_type='tx_code_009'
	</select>
	<select id="findAccountUnfreeze" parameterType="java.util.Map" resultType="int">
	 select count(*) from ts where ts.order_cs_id=#{id} and ts.userid=#{userid} and ts.ts_type='tx_code_0010'
	</select>
	<select id="findTempInfo" resultType="TempInfo" parameterType="long">
		SELECT * FROM order_temp_details WHERE order_cs_id=#{id} AND deleted=0
	</select>
	<resultMap id="OrderModifyLogInfoResult" type="OrderModifyLogInfo">
		<id property="id" column="id"/>
		<result property="modifier" column="modifier"/>
		<result property="md_time" column="md_time"/>
		<result property="md_column" column="md_column"/>
		<result property="old_value" column="old_value"/>
		<result property="new_value" column="new_value"/>
		<result property="order_exec_id" column="order_exec_id"/>
	</resultMap>
	<select id="findOrderModifyLog" parameterType="java.util.Map" resultMap="OrderModifyLogInfoResult">
		SELECT * FROM order_exec_modify_log WHERE order_exec_id = #{orderExecId} AND deleted = 0 ORDER BY id
		<if test="page != null">
			<if test="rows != null">
				LIMIT #{page}, #{rows}
			</if>
		</if> 
	</select>
	<select id="findAcountOrderModifyLog" parameterType="java.util.Map" resultType="int">
			SELECT count(*) FROM order_exec_modify_log WHERE order_exec_id = #{orderExecId} AND deleted = 0 ORDER BY id
	</select>
	<select id="findLongDistanceInfo" resultType="LongDistanceInfo" parameterType="long">
		SELECT
			tbl_long_detail.*, tbl_long_users.order_exec_cs_id, tbl_long_users.ps_date, tbl_long_users.seat_num, tbl_long_users.userid
		FROM
			order_longdistance_users_cs tbl_long_users INNER JOIN order_longdistance_details tbl_long_detail
			ON tbl_long_users.orderdriverlongdistance_id = tbl_long_detail.id
		WHERE tbl_long_users.deleted = 0 AND tbl_long_detail.deleted = 0 AND tbl_long_users.order_exec_cs_id = #{id}
		
		<!-- 按照长途订单连接 
		order_longdistance_users_cs
		order_longdistance_details
		
		查出指定id的未删除的  order_longdistance_details里面的所有字段 order_longdistance_users_cs里的 订单执行表id: order_exec_cs_id
		上传日期ps_date 座位数:seat_num以及用户id
		 -->
		 
	</select>
	
	<insert id="insertTsInfo" parameterType="hashmap" useGeneratedKeys="true" keyProperty="id">	
		INSERT INTO ts (`order_cs_id`, `oper`, `ts_way`, `balance`, `ts_date`, `userid`, `groupid`, `unitid`, `remark`, `account`, `account_type`, `application`, `ts_type`, `sum`, `deleted`)
		VALUE(#{order_cs_id}, #{oper}, #{ts_way}, #{balance}, NOW(), #{userid}, #{groupid}, #{unitid}, "", #{account}, #{account_type}, #{application}, #{ts_type}, #{sum}, 0)
	</insert>
	
	<select id="findOnoffdutyInfo" resultType="OnoffdutyInfo" parameterType="long">
		SELECT *
		FROM 
			(SELECT
					tbl_onoff_exec.order_cs_id, tbl_onoff_divide.*
				FROM
					order_onoffduty_exec_details tbl_onoff_exec INNER JOIN order_onoffduty_divide tbl_onoff_divide 
					ON tbl_onoff_exec.onoffduty_divide_id = tbl_onoff_divide.id WHERE tbl_onoff_exec.deleted = 0 AND tbl_onoff_divide.deleted = 0
			 )
				tbl_onoff_temp INNER JOIN order_onoffduty_details tbl_onoff_detail ON tbl_onoff_temp.orderdetails_id = tbl_onoff_detail.id
		WHERE tbl_onoff_detail.deleted = 0 AND tbl_onoff_temp.order_cs_id = #{id}
		<!--
		order_onoffduty_exec_details order_onoffduty_divide按照divideID相等连接 
		查出order_onoffduty_exec_details中字段order_cs_id和order_onoffduty_divide中所有字段数据 将这些数据组成的临时表和order_onoffduty_details
		按照临时表里面的orderdetails_id和order_onoffduty_details中的id相等连接
		 按照传入的id查出数据
		查出的数据有 
		order_onoffduty_exec_details中字段order_cs_id和order_onoffduty_divide中所有字段数据order_onoffduty_details中的所有字段
		  -->
	</select>
	
	<select id="search" resultType="Appoint1" parameterType="java.util.Map">
	   SELECT * 
  from (
SELECT tbl_order.id,tbl_order.order_type,tbl_order.passenger,tbl_order.driver,tbl_order.from_,tbl_order.to_,tbl_order.average_price_platform,
        tbl_order.price,tbl_order.pre_time,tbl_order.remark,tbl_order.cr_date,tbl_order.ti_accept_order,tbl_order.begin_exec_time,
        tbl_order.driverarrival_time,tbl_order.beginservice_time,tbl_order.stopservice_time,tbl_order.pay_time,tbl_order.pass_cancel_time,
        tbl_order.driver_cancel_time,tbl_order.password,tbl_order.city_from,tbl_order.city_to,tbl_order.has_evaluation_passenger,tbl_order.has_evaluation_driver,
        tbl_order.begin_lat,tbl_order.begin_lng,tbl_order.end_lat,tbl_order.end_lng,tbl_order.freeze_points,tbl_order.total_distance,city.name as order_city ,tbl_order.status,tbl_order.deleted
  FROM  order_exec_cs tbl_order  
  LEFT JOIN city 
  ON city.code = tbl_order.order_city ) 
         city_tbl_order        
	 <if test="(''!= usercode and usercode !=null) or (''!= username and username !=null) or (''!= userphone and userphone !=null) or (''!= nickname and nickname !=null)">
			LEFT JOIN user u 
			<if test="''!=dept and dept != null">
				<if test="dept == 1">
					ON city_tbl_order.driver = u.id
				</if>
				<if test="dept == 2">
					ON city_tbl_order.passenger = u.id
				</if>
				<if test="dept == 3">
					ON (city_tbl_order.driver = u.id OR city_tbl_order.passenger = u.id) 
				</if> 
			</if>	
			WHERE u.deleted = 0 
			<if test="''!= usercode and usercode !=null">
			AND u.usercode like #{usercode}
			</if>
			<if test="''!= username and username !=null">
			AND u.username like #{username}
			</if>
			<if test="''!= userphone and userphone !=null">
			AND u.phone like #{userphone}
			</if>
			<if test="''!= nickname and nickname !=null">
			AND u.nickname like #{nickname}	
			</if>
		</if>
		<if test="(''== usercode or usercode ==null) and (''== username or username ==null) and (''== userphone or userphone ==null) and (''== nickname or nickname ==null)">
			WHERE city_tbl_order.deleted = 0
		</if>
			AND city_tbl_order.status = #{status}
			<if test="''!=order_city and order_city!=null">
			AND city_tbl_order.order_city like #{order_city}
			</if>
		<if test="beginTime != null">
			<if test="beginTime !=''">
				<choose>
					<when test="status == 1">
						AND city_tbl_order.cr_date >= #{beginTime}
					</when>
					<when test="status == 2">
						AND city_tbl_order.ti_accept_order >= #{beginTime}
					</when>
					<when test="status == 3">
						AND city_tbl_order.begin_exec_time >= #{beginTime}
					</when>
					<when test="status == 4">
						AND city_tbl_order.driverarrival_time >= #{beginTime}
					</when>
					<when test="status == 5">
						AND city_tbl_order.beginservice_time >= #{beginTime}
					</when>
					<when test="status == 6">
						AND city_tbl_order.stopservice_time >= #{beginTime}
					</when>
					<when test="status == 7">
						AND city_tbl_order.pay_time >= #{beginTime}
					</when>
					<when test="status == 8">
						AND city_tbl_order.pass_cancel_time >= #{beginTime}
					</when>
					<when test="status == 9">
						AND city_tbl_order.driver_cancel_time >= #{beginTime}
					</when>
				</choose>				
			</if> 			
		</if>
		<if test="endTime != null">
			<if test="endTime != ''">
				<choose>
					<when test="status == 1">
						AND #{endTime} >= city_tbl_order.cr_date 
					</when>
					<when test="status == 2">
						AND #{endTime} >= city_tbl_order.ti_accept_order 
					</when>
					<when test="status == 3">
						AND #{endTime} >= city_tbl_order.begin_exec_time 
					</when>
					<when test="status == 4">
						AND #{endTime} >= city_tbl_order.driverarrival_time
					</when>
					<when test="status == 5">
						AND #{endTime} >= city_tbl_order.beginservice_time 
					</when>
					<when test="status == 6">
						AND #{endTime} >= city_tbl_order.stopservice_time
					</when>
					<when test="status == 7">
						AND #{endTime} >= city_tbl_order.pay_time
					</when>
					<when test="status == 8">
						AND #{endTime} >= city_tbl_order.pass_cancel_time
					</when>
					<when test="status == 9">
						AND #{endTime} >= city_tbl_order.driver_cancel_time
					</when>
				</choose>		
			</if>			 
		</if>
		AND ( 1=0
		<if test="order_type != null">			
			<if test="order_type1 != null">
				OR city_tbl_order.order_type = #{order_type1}
			</if>
			<if test="order_type2 != null">
				OR city_tbl_order.order_type = #{order_type2}
			</if>
			<if test="order_type3 != null">
				OR city_tbl_order.order_type = #{order_type3}
			</if>		
			<if test="order_type4 != null">
				OR city_tbl_order.order_type = #{order_type4}
			</if>			
		</if>
		)
		<if test="order_num != null">
			<if test="order_num != ''">
				AND city_tbl_order.id = #{order_num}
			</if>
		</if>
		GROUP BY city_tbl_order.id	
		<choose>
					<when test="status == 1">
							order BY city_tbl_order.cr_date desc
					</when>
					<when test="status == 2">
						order BY  city_tbl_order.ti_accept_order desc
					</when>
					<when test="status == 3">
						order BY city_tbl_order.begin_exec_time desc
					</when>
					<when test="status == 4">
						order BY city_tbl_order.driverarrival_time desc
					</when>
					<when test="status == 5">
						order BY city_tbl_order.beginservice_time desc
					</when>
					<when test="status == 6">
						order BY  city_tbl_order.stopservice_time desc
					</when>
					<when test="status == 7">
						order BY city_tbl_order.pay_time desc
					</when>
					<when test="status == 8">
						order BY city_tbl_order.pass_cancel_time desc
					</when>
					<when test="status == 9">
						order BY  city_tbl_order.driver_cancel_time  desc
					</when>
			</choose>	
					
		<if test="page != null">
			<if test="rows != null">
				LIMIT #{page}, #{rows}
			</if>
		</if>		
	</select>
	
	<select id="getWeekdays" resultType="String" parameterType="int">
		SELECT B.which_days FROM order_onoffduty_exec_details A LEFT JOIN order_onoffduty_divide B ON A.onoffduty_divide_id = B.id
		WHERE A.order_cs_id=#{id} AND A.deleted=0 AND B.deleted = 0
	</select>
		
	<update id="editAppoint"  parameterType="Appoint">
		UPDATE order_exec_cs SET from_=#{from_}, to_=#{to_} where id=#{id} AND deleted=0
	</update>
	
	<select id="searchforRecourse" resultMap="AppointResult" parameterType="hashmap">
				SELECT tbl_order.*
		FROM (
      SELECT tbl_exec.*, tbl_temp.order_num	
			FROM (
         SELECT tbl_order.id,tbl_order.order_type,tbl_order.passenger,tbl_order.driver,tbl_order.from_,tbl_order.to_,tbl_order.average_price_platform,
        tbl_order.price,tbl_order.pre_time,tbl_order.remark,tbl_order.cr_date,tbl_order.ti_accept_order,tbl_order.begin_exec_time,
        tbl_order.driverarrival_time,tbl_order.beginservice_time,tbl_order.stopservice_time,tbl_order.pay_time,tbl_order.pass_cancel_time,
        tbl_order.driver_cancel_time,tbl_order.password,tbl_order.city_from,tbl_order.city_to,tbl_order.has_evaluation_passenger,tbl_order.has_evaluation_driver,
        tbl_order.begin_lat,tbl_order.begin_lng,tbl_order.end_lat,tbl_order.end_lng,tbl_order.freeze_points,tbl_order.total_distance,
        city.name as order_city ,tbl_order.deleted,tbl_order.status
          FROM  order_exec_cs tbl_order LEFT JOIN city 
         ON city.code = tbl_order.order_city 
         ) tbl_exec 	INNER JOIN order_temp_details tbl_temp ON tbl_exec.id = tbl_temp.order_cs_id 
				WHERE tbl_exec.deleted = 0 AND tbl_temp.deleted = 0 
			UNION 
			
			SELECT tbl_exec.*, tbl_long.order_num
			FROM
				(
         SELECT tbl_order.id,tbl_order.order_type,tbl_order.passenger,tbl_order.driver,tbl_order.from_,tbl_order.to_,tbl_order.average_price_platform,
        tbl_order.price,tbl_order.pre_time,tbl_order.remark,tbl_order.cr_date,tbl_order.ti_accept_order,tbl_order.begin_exec_time,
        tbl_order.driverarrival_time,tbl_order.beginservice_time,tbl_order.stopservice_time,tbl_order.pay_time,tbl_order.pass_cancel_time,
        tbl_order.driver_cancel_time,tbl_order.password,tbl_order.city_from,tbl_order.city_to,tbl_order.has_evaluation_passenger,tbl_order.has_evaluation_driver,
        tbl_order.begin_lat,tbl_order.begin_lng,tbl_order.end_lat,tbl_order.end_lng,tbl_order.freeze_points,tbl_order.total_distance,
        city.name as order_city ,tbl_order.deleted,tbl_order.status
          FROM  order_exec_cs tbl_order LEFT JOIN city 
         ON city.code = tbl_order.order_city 
         ) tbl_exec 	
			INNER JOIN (
			SELECT tbl_long_details.*, tbl_long_users.orderdriverlongdistance_id, tbl_long_users.order_exec_cs_id, tbl_long_users.ps_date,
								tbl_long_users.seat_num AS long_seat_num, tbl_long_users.userid AS long_passenger, tbl_long_users.ps_date AS long_ps_date
				FROM order_longdistance_users_cs tbl_long_users 
				LEFT JOIN order_longdistance_details tbl_long_details ON tbl_long_users.orderdriverlongdistance_id = tbl_long_details.id
				WHERE tbl_long_users.deleted = 0 AND tbl_long_details.deleted = 0
				) tbl_long
					ON tbl_exec.id = tbl_long.order_exec_cs_id WHERE tbl_exec.deleted = 0
			UNION 
			
			SELECT tbl_exec.*, tbl_onoff_info.order_num	
			FROM
				(
         SELECT tbl_order.id,tbl_order.order_type,tbl_order.passenger,tbl_order.driver,tbl_order.from_,tbl_order.to_,tbl_order.average_price_platform,
        tbl_order.price,tbl_order.pre_time,tbl_order.remark,tbl_order.cr_date,tbl_order.ti_accept_order,tbl_order.begin_exec_time,
        tbl_order.driverarrival_time,tbl_order.beginservice_time,tbl_order.stopservice_time,tbl_order.pay_time,tbl_order.pass_cancel_time,
        tbl_order.driver_cancel_time,tbl_order.password,tbl_order.city_from,tbl_order.city_to,tbl_order.has_evaluation_passenger,tbl_order.has_evaluation_driver,
        tbl_order.begin_lat,tbl_order.begin_lng,tbl_order.end_lat,tbl_order.end_lng,tbl_order.freeze_points,tbl_order.total_distance,
        city.name as order_city ,tbl_order.deleted,tbl_order.status
          FROM  order_exec_cs tbl_order LEFT JOIN city 
         ON city.code = tbl_order.order_city 
         ) tbl_exec 
				INNER JOIN (SELECT tbl_onoff_details.*, tbl_join_onoff_exec_and_devide.order_cs_id
								FROM order_onoffduty_details tbl_onoff_details
								INNER JOIN (SELECT tbl_onoff_diviede.*, tbl_onoff_exec.order_cs_id FROM order_onoffduty_exec_details tbl_onoff_exec  
								INNER JOIN order_onoffduty_divide tbl_onoff_diviede ON tbl_onoff_exec.onoffduty_divide_id = tbl_onoff_diviede.id
								WHERE tbl_onoff_diviede.deleted = 0 AND tbl_onoff_exec.deleted = 0) tbl_join_onoff_exec_and_devide
								ON tbl_onoff_details.id = tbl_join_onoff_exec_and_devide.orderdetails_id WHERE tbl_onoff_details.deleted = 0) tbl_onoff_info
				ON tbl_exec.id = tbl_onoff_info.order_cs_id WHERE tbl_exec.deleted = 0
				) tbl_order
				
		<if test="identity != null and ''!=identity">
			LEFT JOIN user u ON 1=0
			<if test="identity1 != null and ''!=identity1">
				 OR tbl_order.driver = u.id
			</if>
			<if test="identity2 != null and ''!=identity2">
				OR tbl_order.passenger = u.id
			</if>
			WHERE tbl_order.deleted=0
			<if test="id != 0">
			AND u.id = #{id}
			</if>
			<if test="''!= userName and userName !=null">
			AND u.username like #{userName}
			</if>
			<if test="''!= userPhone and userPhone !=null">
			AND u.phone like #{userPhone}
			</if>

		</if>
			
		AND( 1=0	
		<if test="order_state != null and ''!= order_state">
			
			<if test="order_state1 != null and ''!= order_state1">	
			 OR tbl_order.status = 1
			</if>
			<if test="order_state2 != null and ''!= order_state2">	
			OR tbl_order.status != 1
			</if>
			
		</if>
		)
		AND ( 1=0
		<if test="order_type != null  and ''!= order_type">
			<if test="order_type1 != null and ''!= order_type1">
				OR tbl_order.order_type = #{order_type1}
			</if>
			<if test="order_type2 != null  and ''!= order_type2">
				OR tbl_order.order_type = #{order_type2}
			</if>
			<if test="order_type3 != null  and ''!= order_type3">
				OR tbl_order.order_type = #{order_type3}
			</if>
				<if test="order_type4 != null  and ''!= order_type4">
				OR tbl_order.order_type = #{order_type4}
			</if>
		</if>
		)
		
		<if test="beginTime != null">
			<if test="beginTime !=''">
				AND tbl_order.ti_accept_order >= #{beginTime}
			</if> 			
		</if>
		<if test="endTime != null">
			<if test="endTime != ''">
				AND #{endTime} >= tbl_order.ti_accept_order 
			</if>			 
		</if>
		<if test="orderNum != null">
			<if test="orderNum != ''">
				AND tbl_order.id =${orderNum}
			</if>
		</if>
		ORDER BY tbl_order.id
		<if test="page != null">
			<if test="rows != null">
				LIMIT #{page}, #{rows}
			</if>
		</if>
	</select>
	
	<select id="findMidPoints" resultMap="MidPointsResult" parameterType="hashmap">
		SELECT * FROM midpoints WHERE deleted = 0 AND order_type = #{order_type} AND orderid = #{detailsId}
	</select>	
	
	<update id="updateMidpoints" parameterType="hashmap">
		UPDATE midpoints SET addr=#{addr} WHERE order_type=#{order_type} AND orderid=#{orderid} AND point_index=#{index} AND deleted=0;		  
	</update>
	<insert id="insertOrderHistory" parameterType="hashmap" useGeneratedKeys="true"  keyProperty="id">
		INSERT INTO order_exec_modify_log (modifier, md_time, md_column, old_value, new_value, order_exec_id, deleted)
		VALUE (#{modifier}, NOW(), #{md_column}, #{old_value}, #{new_value}, #{order_exec_id}, 0)
	</insert>
	
	<update id="updateOrderExecCs" parameterType="hashmap">
		UPDATE order_exec_cs SET price=#{price}, from_=#{from_}, to_=#{to_}, status=#{status}
		<if test="cr_date != null">
			<if test="cr_date != ''">
				, cr_date=#{cr_date}
			</if>
		</if>
		<if test="beginservice_time != null">
			<if test="beginservice_time != ''">
				, beginservice_time=#{beginservice_time}
			</if>
		</if>
		<if test="pay_time != null">
			<if test="pay_time != ''">
				, pay_time=#{pay_time}
			</if>
		</if>
		<if test="ti_accept_order != null">
			<if test="ti_accept_order != ''">
				, ti_accept_order=#{ti_accept_order}
			</if>
		</if>
		<if test="begin_exec_time != null">
			<if test="begin_exec_time != ''">
				, begin_exec_time=#{begin_exec_time}
			</if>
		</if>
			<if test="password != null">
			<if test="password != ''">
				, password=#{password}
			</if>
		</if>
		<if test="driverarrival_time != null">
			<if test="driverarrival_time != ''">
				, driverarrival_time=#{driverarrival_time}
			</if>
		</if>
		<if test="stopservice_time != null">
			<if test="stopservice_time != ''">
				, stopservice_time=#{stopservice_time}
			</if>
		</if>
		<if test="city_from != null">
			<if test="city_from != ''">
				, city_from=#{city_from}
			</if>
		</if>
		<if test="city_to != null">
			<if test="city_to != ''">
				, city_to=#{city_to}
			</if>
		</if>
		<if test="remark != null">
			<if test="remark != ''">
				, remark=#{remark}
			</if>
		</if>
		WHERE id=#{order_exec_id} AND deleted=0
	</update>
	
	<update id="updateOrderTempDetail" parameterType="hashmap">
		UPDATE order_temp_details SET price=#{price}
		<if test="beginservice_time != null">
			<if test="beginservice_time != ''">
				, beginservice_time=#{beginservice_time}
			</if>
		</if>
		<if test="pay_time != null">
			<if test="pay_time != ''">
				, pay_time=#{pay_time}
			</if>
		</if>
		<if test="ps_date != null">
			<if test="ps_date != ''">
				, ps_date=#{ps_date}
			</if>
		</if>
			<if test="accept_time != null">
			<if test="accept_time != ''">
				, accept_time=#{accept_time}
			</if>
		</if>
			<if test="begin_exec_time != null">
			<if test="begin_exec_time != ''">
				, begin_exec_time=#{begin_exec_time}
			</if>
		</if>
			<if test="driverarrival_time != null">
			<if test="driverarrival_time != ''">
				, driverarrival_time=#{driverarrival_time}
			</if>
		</if>
			<if test="endservice_time != null">
			<if test="endservice_time != ''">
				, endservice_time=#{endservice_time}
			</if>
		</if>
		<if test="pre_time != null">
			<if test="pre_time != ''">
				, pre_time=#{pre_time}
			</if>
		</if>
		<if test="remark != null">
			<if test="remark != ''">
				, remark=#{remark}
			</if>
		</if>
		<if test="start_addr != null">
			<if test="start_addr != ''">
				, start_addr=#{start_addr}
			</if>
		</if>
		<if test="end_addr != null">
			<if test="end_addr != ''">
				, end_addr=#{end_addr}
			</if>
		</if>
		<if test="remark != null">
			, remark=#{remark}
		</if>
		, status=#{status}, reqcarstyle=#{reqcarstyle}		
		WHERE id = #{id}
	</update>
	
	<update id="updateUserBalance_ts">
		UPDATE user SET balance_ts = #{param2} WHERE user.id = #{param1}
	</update>
	
	<resultMap id="FreezeTsInfoResult" type="FreezeTsInfo">
		<id property="id" column="id"/>
		<result property="userId" column="userId"/>
		<result property="balance" column="balance"/>
		<result property="freeze_ts_id" column="freeze_ts_id"/>
		<result property="ts_balance" column="ts_balance"/>
	</resultMap>
	
	<select id="findFreezeTsInfo" resultType="FreezeTsInfo">
		SELECT F.*, T.balance AS ts_balance
		FROM freeze_points F LEFT JOIN ts T ON F.freeze_ts_id = T.id 
		WHERE F.deleted = 0 AND T.deleted = 0 AND T.order_cs_id = #{param1}
		order by F.id desc limit 1;
	</select>
	<update id="updateFreeze" parameterType="hashmap">
		UPDATE freeze_points SET adminid=#{adminid}, balance=#{balance}, state=1, release_ts_id=#{release_ts_id}		
	</update>
	
	<update id="updateOrderOnoffDetail" parameterType="hashmap">
		UPDATE order_onoffduty_details SET price=#{price}, start_addr=#{start_addr}, end_addr=#{end_addr} 
		<if test="ps_date != null">
			<if test="ps_date != ''">
				, publish_date=#{ps_date}
			</if>
		</if>
		<if test="accept_time != null">
			<if test="accept_time != ''">
				, ti_accept_order=#{accept_time}
			</if>
		</if>
		, `status`=#{status}, reqcarstyle=#{reqcarstyle}, remark=#{remark}
		WHERE id=#{id} AND deleted=0
	</update>
	
	<update id="updateOrderLongDetail" parameterType="hashmap">
		UPDATE order_longdistance_details SET price = #{price}
		<if test="start_addr != null">
			<if test="start_addr != ''">
				, start_city=#{start_addr}			
			</if>
		</if>
		<if test="end_addr != null">
			<if test="end_addr != ''">
				, end_city=#{end_addr}			
			</if>
		</if>
		<if test="ps_date != null">
			<if test="ps_date != ''">
				, ps_time=#{ps_date}
			</if>
		</if>
		<if test="accept_time != null">
			<if test="accept_time != ''">
				, ti_accept_order=#{accept_time}
			</if>
		</if>
		<if test="begin_exec_time != null">
			<if test="begin_exec_time != ''">
				, begin_exec_time=#{begin_exec_time}
			</if>
		</if>
		<if test="driverarrival_time != null">
			<if test="driverarrival_time != ''">
				, driverarrival_time=#{driverarrival_time}
			</if>
		</if>
		<if test="endservice_time != null">
			<if test="endservice_time != ''">
				, endservice_time=#{endservice_time}
			</if>
		</if>
		<if test="pre_time != null">
			<if test="pre_time != ''">
				, pre_time=#{pre_time}
			</if>
		</if>
		, `status`=#{status}, remark=#{driverRemark}
		WHERE id=#{id} AND deleted=0
	</update>
	<update id="updateWeekdays">
		UPDATE order_onoffduty_divide SET which_days = #{param1} WHERE deleted = 0 AND orderdetails_id = #{param2}
	</update>
	<update id="deleteOrderExecCs" parameterType="long">
		UPDATE order_exec_cs SET deleted = 1 WHERE id = #{param1}
	</update>
	<!-- 用临时订单,上下班订单,长途订单order_num通过多表连接查询 查询执行订单表的 数据 -->
	<select id="findOnOffDExecByOnum" parameterType="java.util.Map" resultType="ExecDetails">
	select order_exec_cs.id,order_exec_cs.begin_exec_time 
       from (  select order_onoffduty_exec_details.order_cs_id,onoffduty.order_num
                from (  select  order_onoffduty_divide.*,order_onoffduty_details.order_num
                         from order_onoffduty_divide 
                         left join order_onoffduty_details  on order_onoffduty_divide.orderdetails_id=order_onoffduty_details.id
                      ) onoffduty  
                left join order_onoffduty_exec_details on order_onoffduty_exec_details.onoffduty_divide_id=onoffduty.id
            ) onoffduty1 
     left join  order_exec_cs  on order_exec_cs.id=onoffduty1.order_cs_id
     where onoffduty1.order_num=#{order_num}
	</select>
	<select id="findTempExecByOnum" parameterType="java.util.Map" resultType="ExecDetails">
	select * from order_temp_details inner join order_exec_cs on order_temp_details.order_cs_id =order_exec_cs.id
  where order_temp_details.order_num=#{order_num}
	</select>
	<select id="findLongDExecByOnum" parameterType="java.util.Map" resultType="ExecDetails">
		select order_exec_cs.id,order_exec_cs.begin_exec_time
		from (   select order_longdistance_users_cs.order_exec_cs_id ,order_longdistance_details.order_num
	 			 from  order_longdistance_users_cs 
	 			 left join order_longdistance_details  on order_longdistance_users_cs.orderdriverlongdistance_id=order_longdistance_details.id
	 		  ) orderlongdistance 
	 	left join order_exec_cs on order_exec_cs.id =orderlongdistance.order_exec_cs_id
	 	where orderlongdistance.order_num=#{order_num}
	</select>
	
	<select id="getBreakAppointCnt" resultType="int">
		SELECT COUNT(*)
		FROM (SELECT tbl_exec.id, tbl_temp.order_num
		FROM order_temp_details tbl_temp INNER JOIN order_exec_cs tbl_exec ON tbl_temp.order_cs_id = tbl_exec.id WHERE tbl_exec.deleted = 0) T1
		INNER JOIN abb_record T2 ON T1.id = T2.order_exec_id WHERE T2.deleted = 0 AND T1.order_num = #{param1}
	</select>
	
	
</mapper>