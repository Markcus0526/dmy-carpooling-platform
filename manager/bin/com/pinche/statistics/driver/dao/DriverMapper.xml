<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.pinche.statistics.driver.dao.DriverMapper" >

    <resultMap
        id="DriverResult"
        type="Driver" >

        <id
            column="num"
            property="num" />

        <result
            column="countofDriver"
            property="countofDriver" />

        <result
            column="countofDriverReg"
            property="countofDriverReg" />
    </resultMap>

    <select
        id="countofDriver"
        parameterType="hashmap"
        resultType="int" >
		SELECT COUNT(*) FROM driver_online_stat d WHERE 1 

        <if test="beginDate != null" >

            <if test="beginDate != &apos;&apos;" >
				AND DATE_FORMAT(d.ps_date,"%Y-%m-%d") >= #{beginDate}
            </if>
        </if>

        <if test="endDate != null" >

            <if test="endDate != &apos;&apos;" >
				AND #{endDate} >= DATE_FORMAT(d.ps_date,"%Y-%m-%d")
            </if>
        </if>

        <if test="beginTime != null" >

            <if test="beginTime != &apos;&apos;" >
				AND d.hour >= #{beginTime}
            </if>
        </if>

        <if test="endTime != null" >

            <if test="endTime != &apos;&apos;" >
				AND #{endTime} >= d.hour 
            </if>
        </if>
    </select>

    <select
        id="countofDriverReg"
        parameterType="hashmap"
        resultType="int" >
		SELECT COUNT(*) FROM (SELECT d.* FROM driver_online_stat d INNER JOIN user u ON d.userid = u.id
		WHERE u.driver_verified = 1 GROUP BY d.userid) a 
    </select>

    <select
        id="getDriverInfo"
        parameterType="hashmap"
        resultMap="DriverResult" >
			SELECT a.num, b.countofDriver, a.countofDriverReg FROM
				(SELECT a.num, count(A.user_id) as countofDriverReg
					FROM (
							SELECT

        <if test="type==&apos;Year&apos;" >
							YEAR(ps_date) 
        </if>

        <if test="type==&apos;Quarter&apos;" >
							QUARTER(ps_date) 
        </if>

        <if test="type==&apos;Month&apos;" >
							MONTH(ps_date) 
        </if>

        <if test="type==&apos;Week&apos;" >
							WEEK(ps_date) 
        </if>

        <if test="type==&apos;Day&apos;" >
							DAY(ps_date) 
        </if>

        <if test="type==&apos;Time&apos;" >
							HOUR(ps_date) 
        </if>
							AS num, userid AS user_id FROM driver_online_stat GROUP BY num, userid
						) AS A GROUP BY A.num) a
				LEFT JOIN
				(SELECT 

        <if test="type==&apos;Year&apos;" >
							YEAR(ps_date) 
        </if>

        <if test="type==&apos;Quarter&apos;" >
							QUARTER(ps_date) 
        </if>

        <if test="type==&apos;Month&apos;" >
							MONTH(ps_date) 
        </if>

        <if test="type==&apos;Week&apos;" >
							WEEK(ps_date) 
        </if>

        <if test="type==&apos;Day&apos;" >
							DAY(ps_date) 
        </if>

        <if test="type==&apos;Time&apos;" >
							HOUR(ps_date) 
        </if>
				AS num, COUNT(*) AS countofDriver FROM driver_online_stat GROUP BY num	) b on a.num=b.num

        <if test="start != null" >
							ORDER BY a.num LIMIT #{start}, #{end}
        </if>
    </select>

</mapper>