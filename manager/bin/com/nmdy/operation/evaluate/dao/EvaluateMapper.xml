<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.nmdy.operation.evaluate.dao.EvaluateMapper" >

    <resultMap
        id="msg"
        type="java.util.Map" >
        
         <result
            column="msg"
            property="msg" />
    </resultMap>
    <resultMap
        id="EvResult"
        type="com.nmdy.operation.evaluate.dao.EvaluateEntity" >
  <result
            column="eid"
            property="eid" />

     
        <result
            column="id"
            property="userid" />

        <result
            column="city_register"
            property="city_register" />

        <result
            column="city_cur"
            property="city_cur" />

        <result
            column="username"
            property="username" />

        <result
            column="phone"
            property="phone" />

        <result
            column="usertype"
            property="usertype" />

        <result
            column="level"
            property="level" />

        <result
            column="order_cs_id"
            property="order_cs_id" />

        <result
            column="from_userid"
            property="from_userid" />

        <result
            column="ps_date"
            property="ps_date" />

        <result
            column="msg"
            property="msg" />

        <result
            column="ga_code"
            property="ga_code" />

        <result
            column="ga_name"
            property="ga_name" />

        <result
            column="passnum"
            property="passnum" />

        <result
            column="drinum"
            property="drinum" />

        <result
            column="to_userid"
            property="to_userid" />

        <result
            column="ckpl"
            property="ckpl" />

        <result
            column="czpl"
            property="czpl" />

        <result
            column="cklevelt"
            property="cklevelt" />

        <result
            column="czlevelt"
            property="czlevelt" />

        <result
            column="ckhp"
            property="ckhp" />

        <result
            column="czhp"
            property="czhp" />

        <result
            column="cklevelt1"
            property="cklevelt1" />

        <result
            column="blocked"
            property="deleted" />

        <result
            column="driver_verified"
            property="driver_verified" />
    </resultMap>

    <resultMap
        id="EvResult1"
        type="com.nmdy.operation.evaluate.dao.HelpEntity" >

        <result
            column="ckpl1"
            property="ckpl1" />

        <result
            column="czpl1"
            property="czpl1" />

        <result
            column="passnum"
            property="cklevelt1" />

        <result
            column="drinum"
            property="czlevelt1" />
    </resultMap>
    <!-- 页面加载查询方法 -->

    <select
        id="finduser"
        parameterType="java.util.Map"
        resultMap="EvResult" >
		SELECT u.id,u.username,u.phone,ifnull(g.group_name,'没有找到')as group_name, CASE WHEN u.driver_verified=1 THEN '车主' ELSE '乘客' END driver_verified,ifnull(gad.associd,'没有找到')as associd,ifnull(ga.ga_code,'没有找到')as ga_code,

ifnull(ga.ga_name,'没有找到') as ga_name
FROM (((user u
LEFT JOIN group_details gd ON gd.userid = u.id)
LEFT JOIN group_ g ON g.groupid=gd.groupid)
LEFT JOIN group_association_details gad ON gad.groupid=g.groupid)
LEFT JOIN group_association ga ON ga.id=gad.associd
WHERE u.deleted=0

        <if test="userid!= null and &apos;&apos; != userid" >
              AND u.id = #{userid}  
        </if>

        <if test="phone!= null and &apos;&apos; != phone" >
              AND u.phone = #{phone}  
        </if>

        <if test="username!= null and &apos;&apos; != username" >
              AND u.username = #{username}  
        </if>

        <if test="city_register!= null and &apos;&apos; != city_register" >
              AND u.city_register = #{city_register}  
        </if>

        <if test="city_cur!= null and &apos;&apos; != city_cur" >
              AND u.city_cur = #{city_cur}  
        </if>

        <if test="city_cur1!= null and &apos;&apos; != city_cur1" >
              AND u.city_cur = #{city_cur1}  or u.city_register = #{city_cur1}  
        </if>

        <if test="ga_code!= null and &apos;&apos; != ga_code" >
              AND ga.ga_code = #{ga_code}  
        </if>

        <if test="ga_name!= null and &apos;&apos; != ga_name" >
		AND ga.ga_name = #{ga_name}
        </if>

        <if test="driver_verified!= null and &apos;&apos; != driver_verified" >
		AND u.driver_verified = #{driver_verified}
        </if>
	    group by u.id
	LIMIT #{start},#{limit} ;
    </select>

    <select
        id="getTotal"
        parameterType="java.util.Map"
        resultType="int" >
			select count(*)
		
FROM (((user u
LEFT JOIN group_details gd ON gd.userid = u.id)
LEFT JOIN group_ g ON g.groupid=gd.groupid)
LEFT JOIN group_association_details gad ON gad.groupid=g.groupid)
LEFT JOIN group_association ga ON ga.id=gad.associd
WHERE u.deleted=0

        <if test="city_cur1!= null and &apos;&apos; != city_cur1" >
              AND u.city_cur = #{city_cur1}  or u.city_register = #{city_cur1}  
        </if>

        <if test="userid!= null and &apos;&apos; != userid" >
              AND u.id = #{userid}  
        </if>

        <if test="phone!= null and &apos;&apos; != phone" >
              AND u.phone = #{phone}  
        </if>

        <if test="username!= null and &apos;&apos; != username" >
              AND u.username = #{username}  
        </if>

        <if test="city_register!= null and &apos;&apos; != city_register" >
              AND u.city_register = #{city_register}  
        </if>

        <if test="city_cur!= null and &apos;&apos; != city_cur" >
              AND u.city_cur = #{city_cur}  
        </if>

        <if test="ga_code!= null and &apos;&apos; != ga_code" >
              AND ga.ga_code = #{ga_code}  
        </if>

        <if test="ga_name!= null and &apos;&apos; != ga_name" >
		AND ga.ga_name = #{ga_name}
        </if>

        <if test="driver_verified!= null and &apos;&apos; != driver_verified" >
		AND u.driver_verified = #{driver_verified}
        </if>
    </select>
    <!-- 查询某个人的信息，好评率，订单数等 -->

    <select
        id="findbyid"
        parameterType="int"
        resultMap="EvResult" >
SELECT u.id,u.username,u.phone,ifnull(g.group_name,'没有找到') as group_name,a.passnum,b.drinum,ck.cklevelt,ckh.ckhp,
 ifnull(CONCAT(CAST(COALESCE(ROUND(ckh.ckhp/ck.cklevelt,2))*100 AS CHAR),'%'),'00.00%')as ckpl,
 cz.czlevelt,czh.czhp, ifnull(CONCAT(CAST(COALESCE(ROUND(czh.czhp/cz.czlevelt,2))*100 AS CHAR),'%'),'00.00%') as czpl 
FROM (
SELECT COUNT(LEVEL) AS czlevelt
FROM evaluation_cs
WHERE to_userid= #{userid} AND usertype=1)cz,(
SELECT COUNT(LEVEL) AS czhp
FROM evaluation_cs
WHERE to_userid= #{userid} AND usertype=1 AND LEVEL=1)czh, (
SELECT COUNT(LEVEL) AS cklevelt
FROM evaluation_cs
WHERE to_userid= #{userid} AND usertype=2)ck,(
SELECT COUNT(LEVEL) AS ckhp
FROM evaluation_cs
WHERE to_userid= #{userid} AND usertype=2 AND LEVEL =1)ckh,(
SELECT COUNT(passenger) AS passnum
FROM order_exec_cs
WHERE passenger = #{userid} and status in (6,7))a,(
SELECT COUNT(driver) AS drinum
FROM order_exec_cs
WHERE driver=#{userid} and status in (6,7))b, (user u left join group_details gd on u.id=gd.userid)left join group_ g
on g.groupid= gd.groupid
WHERE u.id=#{userid} 
    </select>
    <!-- 查询出每个用户的好评率等 -->

    <select
        id="findbyid1"
        parameterType="int"
        resultMap="EvResult1" >
			SELECT IFNULL(tb1.ckpl1,'00.00%') AS ckpl1, IFNULL(tb1.czpl1,'00.00%') AS czpl1,tb1.cklevelt1,tb1.czlevelt1,a.passnum,b.drinum
FROM (
SELECT ck.cklevelt AS cklevelt1,cz.czlevelt AS czlevelt1, CONCAT(CAST(COALESCE(ROUND(ckh.ckhp/ck.cklevelt,2))*100 AS CHAR),'%') AS ckpl1, CONCAT(CAST(COALESCE(ROUND(czh.czhp/cz.czlevelt,2))*100 AS CHAR),'%') AS czpl1
FROM (
SELECT COUNT(LEVEL) AS czlevelt
FROM evaluation_cs e
LEFT JOIN order_exec_cs o ON e.order_cs_id = o.id
WHERE e.to_userid=o.driver AND e.to_userid=#{userid})cz,(
SELECT COUNT(LEVEL) AS czhp
FROM evaluation_cs e
LEFT JOIN order_exec_cs o ON e.order_cs_id = o.id
WHERE e.to_userid=o.driver AND e.to_userid=#{userid} AND LEVEL=1)czh,
		(
SELECT COUNT(LEVEL) AS cklevelt
FROM evaluation_cs e
LEFT JOIN order_exec_cs o ON e.order_cs_id = o.id
WHERE e.to_userid=o.passenger AND e.to_userid=#{userid})ck,(
SELECT COUNT(LEVEL) AS ckhp
FROM evaluation_cs e
LEFT JOIN order_exec_cs o ON e.order_cs_id = o.id
WHERE e.to_userid=o.passenger AND e.to_userid=#{userid} AND LEVEL =1)ckh)tb1,(
SELECT COUNT(passenger) AS passnum
FROM order_exec_cs
WHERE passenger = #{userid} and status in (6,7))a,(
SELECT COUNT(driver) AS drinum
FROM order_exec_cs
WHERE driver=#{userid} and status in (6,7))b
    </select>
    <!-- 某用户的所有评价信息 -->

    <select
        id="findbyid2"
        parameterType="java.util.Map"
        resultMap="EvResult" >
			select date_format(e.ps_date,'%Y年%m月%d日') as ps_date,e.id as eid,
			 level,
			e.from_userid,e.order_cs_id,e.msg,case when e.usertype=2 then '乘客' else '车主' end usertype,
			case when  e.blocked=0 then '有效'  else '屏蔽' end blocked 
			from evaluation_cs e 
				where deleted=0 and e.to_userid=#{userid} 

        <if test="usertype!= null and &apos;&apos; != usertype" >
              AND e.usertype = #{usertype}  
        </if>

        <if test="level1!=0 and level2!=0 and level3!=0" >
              AND e.level in(#{level1},#{level2},#{level3}) 
        </if>


        <if test="deleted!=-1" >
              AND e.blocked = #{deleted}  
        </if>
        LIMIT #{start},#{limit} ;
    </select>

    <select
        id="getTotal2"
        parameterType="java.util.Map"
        resultType="int" >
		select count(*) from evaluation_cs e 
				where deleted=0 and e.to_userid=#{userid} 

        <if test="usertype!= null and &apos;&apos; != usertype" >
              AND e.usertype = #{usertype}  
        </if>

        <if test="level1!=0 and level2!=0 and level3!=0" >
              AND e.level in(#{level1},#{level2},#{level3}) 
        </if>

        <if test="deleted!=-1" >
              AND e.blocked = #{deleted}  
        </if>
    </select>
    <!-- 评价修改 -->
    <select
        id="findmsg"
        parameterType="java.util.Map"
        resultMap="msg" >
select msg from evaluation_cs where id=#{eid}
     
    </select>
    <update
        id="update"
        parameterType="java.util.Map" >
		update evaluation_cs

        <set>

            <if test="level!= null" >
level=#{level},
            </if>

            <if test="msg!= null" >
msg=#{msg}
            </if>
        </set>
		where order_cs_id=#{order_cs_id}
    </update>
    <!-- 屏蔽 -->

    <update
        id="updatedel"
        parameterType="java.util.Map" >
		update evaluation_cs

        <set>

            <if test="deleted!= -1" >
blocked=#{deleted},
            </if>
        </set>
		where order_cs_id=#{order_cs_id}
    </update>

</mapper>