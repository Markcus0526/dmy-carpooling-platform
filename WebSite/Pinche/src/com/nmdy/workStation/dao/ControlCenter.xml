<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.nmdy.workStation.dao.ControlCenterDao">
<resultMap id="controlCenterMap" type="UserOnline">
<id column="id" property="id" />
<result column="lat" property="lat" />
<result column="lng" property="lng" />
<result column="group_name" property="groupName" />
<result column="status" property="status" />
<result column="userid" property="userid" />
<association property="user" javaType="User">
	<result column="userid" property="id" /> 
	<result column="username" property="username" /> 
	<result column="phone" property="phone" /> 
</association>
</resultMap>

<select id="selectUnLineAll" parameterType="hashmap" resultMap="controlCenterMap">
<![CDATA[
select a.id,a.lat,a.lng,b.username,b.phone,b.id as userid,1 as status,
case 
when d.group_name is null or d.group_name = '' then 'null'
else d.group_name end
as group_name
from user_online a
left join user b on a.userid = b.id
left join city e on b.city_cur = e.code
left join group_details c on b.id = c.id
left join group_ d on c.groupid = d.id
where b.city_cur = #{code}
and  DATE_ADD(last_heartbeat_time,INTERVAL #{second} SECOND)<now() 
]]>   
</select>

<select id="countUnlineAll" parameterType="hashmap" resultType="int">
<![CDATA[
select count(*)
from user_online a
left join user b on a.userid = b.id
left join city e on b.city_cur = e.code
left join group_details c on b.id = c.id
left join group_ d on c.groupid = d.id
where b.city_cur = #{code}
and  DATE_ADD(last_heartbeat_time,INTERVAL #{second} SECOND)<now()
]]>   
</select>

<select id="selectOnlineAll" parameterType="hashmap" resultMap="controlCenterMap">
<![CDATA[
select a.id,a.lat,a.lng,b.username,b.phone,b.id as userid,0 as status,
case 
when d.group_name is null or d.group_name = '' then 'null'
else d.group_name end
as group_name
from user_online a
left join user b on a.userid = b.id
left join city e on b.city_cur = e.code
left join group_details c on b.id = c.id
left join group_ d on c.groupid = d.id
where b.city_cur = #{code}
and  DATE_ADD(last_heartbeat_time,INTERVAL #{second} SECOND)>=now()
]]>   
</select>

<select id="countOnlineAll" parameterType="hashmap" resultType="int">
<![CDATA[
select count(*)
from user_online a
left join user b on a.userid = b.id
left join city e on b.city_cur = e.code
left join group_details c on b.id = c.id
left join group_ d on c.groupid = d.id
where b.city_cur = #{code}
and  DATE_ADD(last_heartbeat_time,INTERVAL #{second} SECOND)>=now()
]]>  
</select>

<select id="selectAll" parameterType="hashmap" resultMap="controlCenterMap">
 select a.id,a.lat,a.lng,b.username,b.phone,b.id as userid,
case 
when d.group_name is null or d.group_name = '' then 'null'
else d.group_name end
as group_name
from user_online a
left join user b on a.userid = b.id
left join group_details c on b.id = c.id
left join group_ d on c.groupid = d.id
where  b.city_cur = #{code} and
b.driver_verified=1
</select>

<select id="countAll" parameterType="hashmap" resultType="int">
 select count(*)
from user_online a
left join user b on a.userid = b.id
left join group_details c on b.id = c.id
left join group_ d on c.groupid = d.id
where  b.city_cur = #{code} and
b.driver_verified=1
</select>



<select id="selectSecond" resultType="int">
select value from environment where code='heartbeat_validperiod'
</select>


<select id="findById" parameterType="Long" resultMap="controlCenterMap">
select * from user_online where id=#{id}
</select>

<insert id="insertControlCenter" parameterType="UserOnline">
insert into user_online(
lat,
lng,
login_time,
last_heartbeat_time,
userid,
deleted)
values(
#{lat},
#{lng},
#{loginTime},
#{lastHeartbeatTime},
#{userid},
#{deleted})
</insert>

<update id="updateControlCenter" parameterType="UserOnline">
update user_online set 
lat=#{lat},
lng=#{lng},
login_time=#{loginTime},
last_heartbeat_time=#{lastHeartbeatTime},
userid=#{userid},
deleted=#{deleted} where id=#{id}
</update>

<delete id="deleteControlCenter" parameterType="Long">
delte from user_online where id=#{id}
</delete>
</mapper>

